#!/usr/bin/env python3
from pynput import keyboard
from pynput.keyboard import Key, Controller
from pydub import AudioSegment
from pydub.playback import play
import json
import sys
from os.path import expanduser

keyboard_controller = Controller()
config_path = expanduser("~") + "/.config/soundboard.json"
bindings = {}
help_key = "?"

special_keys = {Key.f1: 'f1',
        Key.f2: 'f2',
        Key.f3: 'f3',
        Key.f4: 'f4',
        Key.f5: 'f5',
        Key.f6: 'f6',
        Key.f7: 'f7',
        Key.f8: 'f8',
        Key.f9: 'f9',
        Key.f10: 'f10',
        Key.f11: 'f11',
        Key.f12: 'f12'}

with open(config_path) as config:
    data = json.load(config)
    for binding in data['bindings']:
        try:
            key = binding['key']
        except KeyError:
            print('Missing key')
            sys.exit(1)

        try:
            sound = binding['sound']
        except KeyError:
            print('Missing sound')
            sys.exit(1)

        try:
            name = binding['name']
        except KeyError:
            name = None

        bindings[key] = (sound, name)

    try:
        help_key = data['help']
    except KeyError:
        pass


def key_names(key):
    try:
        print('alphanumeric key {0} pressed'.format(
            key.char))
    except AttributeError:
        print('special key {0} pressed'.format(
            key))

def play_song(song):
    # Debug Code
    # ten_seconds = 3 * 1000
    # first_10_seconds = song[:ten_seconds]
    # play(first_10_seconds)
    play(song)

def help_screen():
    for key in bindings:
        print(f"{key}: {bindings[key][1]}: {bindings[key][0]}")

def on_press(key):
    try:
        if key.char == help_key:
            help_screen()
        elif key.char in bindings:
            song = AudioSegment.from_file(bindings[key.char])
            play_song(song)
    except AttributeError:
        if key in special_keys:
            key = special_keys[key]
        if key == help_key:
            help_screen()
        elif key in bindings:
            song = AudioSegment.from_file(bindings[key][0])
            play_song(song)

# Collect events until released
with keyboard.Listener(
        on_press=on_press) as listener:
    listener.join()
